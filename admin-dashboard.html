<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Knockout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Rajdhani', sans-serif; }</style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 pb-20">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6 sticky top-0 bg-gray-900 z-50 py-2">
        <h1 class="text-2xl font-bold text-white tracking-wide">Admin Dashboard</h1>
        <button onclick="logoutAdmin()" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition active:scale-95">
            Logout
        </button>
    </div>

    <!-- Stats Section -->
    <div class="grid grid-cols-2 gap-4 mb-6" id="statsContainer">
        <!-- Skeleton Loaders -->
        <div class="animate-pulse bg-gray-800 rounded-lg h-24 border border-gray-700"></div>
        <div class="animate-pulse bg-gray-800 rounded-lg h-24 border border-gray-700"></div>
        <div class="animate-pulse bg-gray-800 rounded-lg h-24 border border-gray-700 col-span-2"></div>
    </div>

    <!-- Navigation Menu -->
    <div class="space-y-4">
        <a href="/admin/users" class="flex items-center justify-between bg-gray-800 p-4 rounded-lg shadow-md border border-gray-700 hover:border-blue-500 transition active:scale-95">
            <h3 class="font-bold text-lg text-white">Manage Users</h3>
            <i class="fa-solid fa-users text-blue-400"></i>
        </a>
        <a href="/admin/categories" class="flex items-center justify-between bg-gray-800 p-4 rounded-lg shadow-md border border-gray-700 hover:border-blue-500 transition active:scale-95">
            <h3 class="font-bold text-lg text-white">Manage Categories</h3>
            <i class="fa-solid fa-list text-blue-400"></i>
        </a>
        <a href="/admin/payments" class="flex items-center justify-between bg-gray-800 p-4 rounded-lg shadow-md border border-gray-700 hover:border-blue-500 transition active:scale-95">
            <h3 class="font-bold text-lg text-white">Manage Payments</h3>
            <i class="fa-solid fa-dollar-sign text-blue-400"></i>
        </a>
    </div>

    <script>
        // --- Authentication Check (Client Side) ---
        // Ensures user is logged in before loading dashboard data.
        // If not logged in, redirects to login page.
        function checkAdminAuth() {
            const adminToken = localStorage.getItem('adminToken');
            if (!adminToken) {
                // If token is missing, redirect to login page
                window.location.href = '/index.html';
            }
        }

        // --- Fetch Dashboard Stats ---
        async function loadDashboardStats() {
            const statsContainer = document.getElementById('statsContainer');
            // Show skeleton loader initially
            statsContainer.innerHTML = `
                <div class="animate-pulse bg-gray-800 rounded-lg h-24 border border-gray-700"></div>
                <div class="animate-pulse bg-gray-800 rounded-lg h-24 border border-gray-700"></div>
                <div class="animate-pulse bg-gray-800 rounded-lg h-24 border border-gray-700 col-span-2"></div>
            `;

            try {
                const adminToken = localStorage.getItem('adminToken');
                if (!adminToken) throw new Error("Authentication token missing. Please log in again.");

                const res = await fetch('/api/admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}` // Send token for authentication
                    },
                    body: JSON.stringify({ type: 'dashboard_stats' }) // Back-end expects 'type' parameter
                });

                if (!res.ok) {
                    // Handle non-200 status codes (e.g., 401 Unauthorized)
                    const errorDetails = await res.json();
                    if (res.status === 401 || res.status === 403) {
                        localStorage.removeItem('adminToken');
                        window.location.href = '/index.html'; // Redirect on auth failure
                    }
                    throw new Error(errorDetails.error || `HTTP error! status: ${res.status}`);
                }

                const data = await res.json();

                if (!data.success) {
                    throw new Error(data.error || 'API call failed without specific error message.');
                }

                // --- UI Update with Stats ---
                statsContainer.innerHTML = `
                    <div class="bg-gray-800 p-4 rounded-lg shadow-md border border-gray-700">
                        <p class="text-xs text-gray-400 uppercase font-bold">Total Users</p>
                        <p class="text-2xl font-bold text-white">${data.totalUsers || 0}</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg shadow-md border border-gray-700">
                        <p class="text-xs text-gray-400 uppercase font-bold">New Registrations</p>
                        <p class="text-2xl font-bold text-white">${data.newRegistrations || 0}</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg shadow-md border border-gray-700 col-span-2">
                        <p class="text-xs text-gray-400 uppercase font-bold">Pending Deposits</p>
                        <p class="text-2xl font-bold text-white">à§³${data.pendingDeposits || 0}</p>
                    </div>
                `;

            } catch (err) {
                console.error('Error loading dashboard stats:', err);
                statsContainer.innerHTML = `<p class="text-center text-red-500 col-span-2 py-4">Error loading data: ${err.message}</p>`;
            }
        }

        // --- Logout Functionality ---
        function logoutAdmin() {
            localStorage.removeItem('adminToken');
            window.location.href = '/index.html';
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAdminAuth();
            loadDashboardStats();
        });
    </script>
</body>
</html>
