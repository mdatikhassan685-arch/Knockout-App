<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>body { user-select: none; } .custom-scroll::-webkit-scrollbar { width: 3px; background: #1f2937; } .custom-scroll::-webkit-scrollbar-thumb { background: #eab308; }</style>
</head>
<body class="bg-gray-900 text-white pb-24 font-sans">

    <!-- Header -->
    <header class="p-4 bg-gray-800 shadow-md flex items-center sticky top-0 z-50 border-b border-gray-700">
        <a href="/home" class="mr-4 text-gray-400 active:scale-90"><i class="fa-solid fa-arrow-left text-xl"></i></a>
        <div>
            <h1 class="font-bold text-lg text-yellow-500 truncate w-64" id="page_title">Tournaments</h1>
            <p class="text-[10px] text-gray-400">Official Events</p>
        </div>
    </header>

    <!-- LIST -->
    <div class="p-4 space-y-4" id="tour_list">
        <p class="text-center text-gray-500 mt-10 animate-pulse">Loading Tournaments...</p>
    </div>

    <!-- REGISTRATION MODAL -->
    <div id="regModal" class="fixed inset-0 bg-black/95 z-[60] hidden items-end md:items-center justify-center p-0 md:p-4 backdrop-blur-sm">
        <div class="bg-gray-900 w-full max-w-sm h-[85vh] md:h-auto rounded-t-3xl md:rounded-2xl border-t md:border border-gray-700 flex flex-col relative shadow-2xl overflow-hidden">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-800/80 backdrop-blur-md sticky top-0 z-10">
                <h3 class="font-bold text-lg text-white tracking-wide">Team Registration</h3>
                <button onclick="closeModal()" class="text-gray-400 text-2xl hover:text-white">&times;</button>
            </div>
            
            <div class="p-5 overflow-y-auto custom-scroll flex-1 space-y-4 pb-24">
                <input type="hidden" id="target_tour_id">
                <div>
                    <label class="text-[10px] font-bold text-blue-400 uppercase ml-1 block mb-1">Team Name (Required)</label>
                    <input type="text" id="reg_team_name" class="w-full bg-gray-800 p-3 rounded-lg border border-gray-600 text-white outline-none focus:border-blue-500 text-sm font-bold placeholder-gray-600">
                </div>
                <div class="space-y-3">
                    <p class="text-[10px] text-gray-500 font-bold uppercase border-b border-gray-700 pb-1">Team Members (4 Players)</p>
                    <div id="player_inputs" class="space-y-3"></div>
                </div>
            </div>

            <div class="p-4 border-t border-gray-800 bg-gray-900 sticky bottom-0 z-20">
                <button onclick="submitReg()" id="submit_btn" class="w-full bg-blue-600 hover:bg-blue-700 py-3.5 rounded-xl font-bold uppercase tracking-wide text-sm shadow-lg transition">Confirm & Pay</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toastBox" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-5 py-3 rounded-full shadow-2xl border border-gray-600 hidden items-center gap-3 z-[100] min-w-[280px] max-w-[90%] justify-center">
        <i id="toastIcon" class="fa-solid text-lg"></i><span id="toastMsg" class="text-xs font-bold tracking-wide text-center">Message</span>
    </div>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 w-full bg-[#0f172a]/95 backdrop-blur-lg border-t border-gray-800 flex justify-around py-3 z-50 pb-6">
        <a href="/home" class="text-gray-500 hover:text-white flex flex-col items-center group transition"><i class="fa-solid fa-house text-xl mb-1 group-active:scale-90"></i><span class="text-[10px]">Home</span></a>
    </nav>

    <script>
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) window.location.href = '/';
        const params = new URLSearchParams(window.location.search);
        
        let catId = params.get('cat_id') || sessionStorage.getItem('last_cat_id');
        const catName = params.get('name');
        
        if(catId) sessionStorage.setItem('last_cat_id', catId);
        if(catName) document.getElementById('page_title').innerText = decodeURIComponent(catName);

        function showToast(msg, type) {
            const box = document.getElementById('toastBox'), icon = document.getElementById('toastIcon'), txt = document.getElementById('toastMsg');
            box.style.display = 'flex'; txt.innerText = msg;
            icon.className = type === 'success' ? 'fa-solid fa-circle-check text-green-500' : 'fa-solid fa-circle-exclamation text-red-500';
            box.style.borderColor = type === 'success' ? '#22c55e' : '#ef4444';
            setTimeout(() => box.style.display = 'none', 3000);
        }

        async function loadTournaments() {
            try {
                // âœ… Using get_user_tournaments to check registration status
                const res = await fetch('/api/official', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ type: 'get_user_tournaments', category_id: catId, user_id: user.id }) 
                });
                const data = await res.json();
                const list = document.getElementById('tour_list');
                
                if(data.length > 0) {
                    list.innerHTML = data.map(t => {
                        // Logic: Check if user is registered
                        let actionBtn = '';
                        if (t.is_registered) {
                            actionBtn = `
                            <button class="flex-1 bg-green-600/20 text-green-500 border border-green-500/50 py-2.5 rounded-lg text-xs font-bold cursor-default uppercase tracking-wide flex items-center justify-center gap-2">
                                <i class="fa-solid fa-check-circle"></i> Joined
                            </button>`;
                        } else {
                            actionBtn = `
                            <button onclick="openRegister(${t.id})" class="flex-1 bg-gradient-to-r from-yellow-600 to-orange-600 text-black py-2.5 rounded-lg text-xs font-bold hover:opacity-90 transition shadow-lg uppercase tracking-wide">
                                Register
                            </button>`;
                        }

                        return `
                        <div class="bg-gray-800 rounded-xl overflow-hidden shadow-lg border border-gray-700 group transition hover:border-yellow-500/50">
                            <div class="h-32 bg-gray-700 relative">
                                <img src="https://placehold.co/600x300/1f2937/FFF?text=${encodeURIComponent(t.title)}" class="w-full h-full object-cover">
                                <span class="absolute top-2 left-2 bg-yellow-600 text-black text-[10px] font-bold px-2 py-0.5 rounded uppercase">Official</span>
                            </div>
                            
                            <div class="p-4">
                                <h3 class="text-lg font-bold text-white leading-tight mb-2">${t.title}</h3>
                                <div class="flex justify-between items-center text-xs text-gray-400 mb-4">
                                    <span class="flex items-center gap-1"><i class="fa-regular fa-calendar text-yellow-500"></i> ${new Date(t.schedule_time).toLocaleDateString()}</span>
                                    <span class="flex items-center gap-1"><i class="fa-solid fa-users text-blue-500"></i> ${t.total_spots} Slots</span>
                                </div>

                                <div class="flex gap-2">
                                    <button onclick="window.location.href='/official-tournaments?id=${t.id}'" class="flex-1 bg-gray-700 text-gray-300 py-2.5 rounded-lg text-xs font-bold hover:bg-gray-600 transition border border-gray-600">
                                        View Info
                                    </button>
                                    ${actionBtn}
                                </div>
                            </div>
                        </div>
                    `;
                    }).join('');
                } else {
                    list.innerHTML = '<div class="text-center text-gray-500 py-10">No upcoming tournaments.</div>';
                }
            } catch(e) { console.error(e); }
        }

        // --- MODAL LOGIC ---
        function openRegister(tid) {
            document.getElementById('target_tour_id').value = tid;
            let html = '';
            for(let i=1; i<=4; i++) {
                const label = i === 1 ? '(Leader)' : '';
                html += `
                <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
                    <p class="text-[9px] text-gray-400 font-bold mb-1">PLAYER ${i} ${label}</p>
                    <input type="text" id="p_name_${i}" placeholder="In-Game Name" class="w-full bg-gray-900 p-2 rounded border border-gray-600 text-xs text-white mb-2 outline-none focus:border-blue-500">
                    <div class="flex gap-2">
                        <input type="number" id="p_uid_${i}" placeholder="UID" class="w-2/3 bg-gray-900 p-2 rounded border border-gray-600 text-xs text-white outline-none focus:border-blue-500">
                        <input type="number" id="p_lvl_${i}" placeholder="Lvl" class="w-1/3 bg-gray-900 p-2 rounded border border-gray-600 text-xs text-white outline-none focus:border-blue-500 text-center">
                    </div>
                </div>`;
            }
            document.getElementById('player_inputs').innerHTML = html;
            document.getElementById('regModal').style.display='flex';
        }

        function closeModal() { document.getElementById('regModal').style.display='none'; }

        async function submitReg() {
            const tid = document.getElementById('target_tour_id').value;
            const teamName = document.getElementById('reg_team_name').value;
            const btn = document.getElementById('submit_btn');
            
            let players = [];
            for(let i=1; i<=4; i++) {
                const n = document.getElementById(`p_name_${i}`).value;
                const u = document.getElementById(`p_uid_${i}`).value;
                const l = document.getElementById(`p_lvl_${i}`).value;
                if(n && u && l) players.push(`${n} (UID:${u} L:${l})`);
            }

            if(!teamName || players.length < 4) return showToast("Fill all details!", "error");

            btn.innerText = "Processing..."; btn.disabled = true;

            try {
                const res = await fetch('/api/official', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ type: 'register_official_team', user_id: user.id, tournament_id: tid, team_name: teamName, players: players })
                });
                const d = await res.json();
                if(d.success) { 
                    showToast("Registered Successfully!", "success"); 
                    closeModal();
                    loadTournaments(); // Reload to update button state
                } else { 
                    showToast(d.error, "error"); 
                }
            } catch(e) { showToast("Network Error", "error"); }
            
            btn.innerText = "Confirm & Pay"; btn.disabled = false;
        }

        loadTournaments();
    </script>
</body>
</html>
