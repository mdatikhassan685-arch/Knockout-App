<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matches</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Rajdhani', sans-serif; }</style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">

    <!-- Header -->
    <div class="flex items-center mb-6">
        <a href="/home" class="bg-gray-800 p-2 rounded-lg hover:bg-gray-700 mr-4 border border-gray-600"><i class="fa-solid fa-arrow-left"></i></a>
        <h1 class="text-2xl font-bold text-blue-400">Daily Matches</h1>
    </div>

    <div id="matchList" class="space-y-4">
        <p class="text-center text-gray-500 py-10 animate-pulse">Loading matches...</p>
    </div>

    <!-- Join Modal -->
    <div id="joinModal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-2xl w-full max-w-sm border border-gray-600 relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-4">Join Match</h3>
            
            <input type="text" id="ign" placeholder="In-Game Name" class="w-full bg-gray-900 border border-gray-600 p-3 rounded mb-3 text-white">
            <input type="text" id="uid" placeholder="Game UID" class="w-full bg-gray-900 border border-gray-600 p-3 rounded mb-4 text-white">
            
            <button onclick="confirmJoin()" id="joinBtn" class="w-full bg-green-600 py-3 rounded-lg font-bold hover:bg-green-500">Confirm & Pay</button>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const catId = urlParams.get('id');
        const user = JSON.parse(localStorage.getItem('user'));
        let selectedMatchId = null;

        if(!user || !catId) window.location.href = '/home';

        async function loadMatches() {
            try {
                const res = await fetch('/api/tournaments/normal-matches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ catId, userId: user.id })
                });
                const data = await res.json();
                
                const list = document.getElementById('matchList');
                list.innerHTML = '';

                if(data.matches.length === 0) {
                    list.innerHTML = '<p class="text-center text-gray-500">No matches available.</p>';
                    return;
                }

                data.matches.forEach(m => {
                    let btn = m.is_joined 
                        ? `<button disabled class="w-full bg-gray-600 text-gray-300 py-2 rounded-lg font-bold">Joined</button>`
                        : `<button onclick="openModal(${m.id})" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold shadow-lg">Join - ৳${m.entry_fee}</button>`;

                    list.innerHTML += `
                        <div class="bg-gray-800 rounded-xl overflow-hidden shadow-lg border border-gray-700">
                            <div class="relative h-32">
                                <img src="${m.image || 'https://via.placeholder.com/400x200'}" class="w-full h-full object-cover">
                                <div class="absolute top-2 right-2 bg-black/60 px-2 py-1 rounded text-xs font-bold">${m.match_type}</div>
                            </div>
                            <div class="p-4">
                                <h3 class="font-bold text-lg mb-1">${m.title}</h3>
                                <p class="text-xs text-gray-400 mb-3"><i class="fa-solid fa-clock mr-1"></i> ${new Date(m.start_time).toLocaleString()}</p>
                                
                                <div class="flex justify-between text-sm mb-3 bg-gray-900 p-2 rounded">
                                    <span class="text-green-400">Win: ৳${m.prize_pool}</span>
                                    <span class="text-yellow-400">Per Kill: ৳${m.per_kill_prize}</span>
                                </div>
                                ${btn}
                            </div>
                        </div>
                    `;
                });
            } catch (err) { console.error(err); }
        }

        function openModal(id) {
            selectedMatchId = id;
            document.getElementById('joinModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('joinModal').classList.add('hidden');
        }

        async function confirmJoin() {
            const ign = document.getElementById('ign').value;
            const uid = document.getElementById('uid').value;
            const btn = document.getElementById('joinBtn');

            if(!ign || !uid) return alert("Enter details");

            btn.innerText = "Processing...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/tournaments/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.id, tournamentId: selectedMatchId, gameName: ign, gameUid: uid })
                });
                const data = await res.json();
                
                if(data.success) {
                    alert("Joined Successfully!");
                    closeModal();
                    loadMatches();
                } else {
                    alert(data.error);
                }
            } catch (err) {
                alert("Error joining");
            } finally {
                btn.innerText = "Confirm & Pay";
                btn.disabled = false;
            }
        }

        loadMatches();
    </script>
</body>
  </html>
