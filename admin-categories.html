<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Categories</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-900 text-white pb-20 select-none">

    <!-- Header with Dynamic Title -->
    <header class="p-4 bg-gray-800 shadow-md flex items-center sticky top-0 z-50 border-b border-gray-700">
        <a href="/admin" class="mr-4 text-gray-400"><i class="fa-solid fa-arrow-left text-xl"></i></a>
        <div>
            <div class="text-xl font-bold" id="page_title">Loading...</div> <!-- ডায়নামিক টাইটেল -->
            <p class="text-[10px] text-gray-400" id="page_sub">Category Management</p>
        </div>
    </header>

    <!-- Create Form -->
    <div class="p-4 bg-gray-800 m-4 rounded-xl border border-gray-700 shadow-lg">
        <h3 class="font-bold text-md mb-3 border-b border-gray-600 pb-2 text-gray-300">Add New Category</h3>
        
        <input type="hidden" id="edit_id">
        
        <!-- ডায়নামিক প্লেসহোল্ডার (Placeholder) -->
        <label class="text-[10px] text-gray-400 font-bold uppercase ml-1">Title</label>
        <input type="text" id="cat_title" placeholder="Loading..." class="w-full bg-gray-900 p-3 rounded-lg mb-3 border border-gray-600 outline-none text-white focus:border-blue-500">
        
        <label class="text-[10px] text-gray-400 font-bold uppercase ml-1">Image URL</label>
        <input type="text" id="cat_img" class="w-full bg-gray-900 p-3 rounded-lg mb-4 border border-gray-600 outline-none text-white focus:border-blue-500">
        
        <!-- ডায়নামিক বাটন -->
        <button onclick="createCategory()" id="submit_btn" class="w-full bg-gray-700 py-3 rounded-lg font-bold text-gray-300">Create</button>
        <button onclick="resetForm()" id="cancel_btn" class="hidden w-full mt-2 text-sm text-red-400">Cancel Edit</button>
    </div>

    <!-- Active List -->
    <div class="px-4">
        <h3 class="font-bold text-lg mb-3 pl-2 border-l-4 border-blue-500">Active List</h3>
        <div id="cat_list" class="space-y-3 pb-10">
            <p class="text-center text-gray-500 mt-10">Loading Data...</p>
        </div>
    </div>

    <script>
        // 1. URL থেকে মোড ডিটেক্ট করা
        const urlParams = new URLSearchParams(window.location.search);
        let mode = urlParams.get('mode');

        // যদি কোনো কারণে মোড না আসে, তবে 'normal' ধরে নেবে
        if (!mode || (mode !== 'official' && mode !== 'normal')) {
            mode = 'normal';
        }

        console.log("Current Admin Mode:", mode);

        // 2. UI আপডেট করা (Heading & Button Color)
        const pageTitle = document.getElementById('page_title');
        const submitBtn = document.getElementById('submit_btn');
        const inputField = document.getElementById('cat_title');

        if (mode === 'official') {
            // Official Mode
            pageTitle.innerText = "Official Tournaments";
            inputField.placeholder = "Example: World Cup 2025";
            submitBtn.innerText = "Create Tournament";
            submitBtn.classList.replace('bg-gray-700', 'bg-yellow-600');
            submitBtn.classList.add('text-white', 'shadow-lg');
        } else {
            // Normal Mode
            pageTitle.innerText = "Daily Matches";
            inputField.placeholder = "Example: Ludo King, FreeFire Daily";
            submitBtn.innerText = "Create Normal Category";
            submitBtn.classList.replace('bg-gray-700', 'bg-blue-600');
            submitBtn.classList.add('text-white', 'shadow-lg');
        }

        // 3. ডাটা লোড ও ফিল্টার লজিক
        async function loadData() {
            try {
                const res = await fetch('/api/admin', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'get_categories' })
                });
                const allData = await res.json();
                
                // এখানে মূল ফিল্টার হচ্ছে
                const filteredData = allData.filter(item => {
                    if (mode === 'official') {
                        return item.type === 'official';
                    } else {
                        // নরমাল মোডের জন্য 'normal' অথবা যাদের টাইপ নেই তাদের দেখাবে
                        return item.type === 'normal' || !item.type; 
                    }
                });

                const list = document.getElementById('cat_list');
                
                if (filteredData.length > 0) {
                    list.innerHTML = filteredData.map(c => `
                        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 flex justify-between items-center group shadow-md">
                            <div class="flex items-center gap-4">
                                <img src="${c.image}" class="w-14 h-14 rounded-lg bg-black/20 object-cover border border-gray-600">
                                <div>
                                    <h4 class="font-bold text-white text-md mb-1">${c.title}</h4>
                                    <!-- Matches Button Link -->
                                    <a href="/admin-matches?cat_id=${c.id}&name=${c.title}" class="inline-block bg-gray-700 px-3 py-1 rounded text-[10px] font-bold text-gray-300 border border-gray-600 hover:bg-gray-600">
                                        Open Matches <i class="fa-solid fa-arrow-right ml-1"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2">
                                <button onclick="enableEdit(${c.id}, '${c.title}', '${c.image}')" class="text-yellow-500 hover:text-white transition"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteCat(${c.id})" class="text-red-500 hover:text-white transition"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = `<div class="text-center py-10 opacity-50 border-2 border-dashed border-gray-700 rounded-xl m-4">
                        <i class="fa-solid fa-box-open text-4xl mb-3 text-gray-500"></i>
                        <p>No ${mode} items created yet.</p>
                    </div>`;
                }

            } catch (e) { console.error(e); }
        }

        // 4. ক্রিয়েট লজিক (সঠিক মোড পাঠানো হচ্ছে)
        async function createCategory() {
            const title = document.getElementById('cat_title').value;
            const img = document.getElementById('cat_img').value;
            const id = document.getElementById('edit_id').value;

            if(!title || !img) return alert("Please fill inputs!");

            const type = id ? 'edit_category' : 'add_category';
            const catTypeToSend = mode; // 'official' or 'normal'

            await fetch('/api/admin', { 
                method: 'POST', 
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ type, id, title, image: img, cat_type: catTypeToSend }) 
            });
            
            resetForm();
            loadData();
        }

        function enableEdit(id, t, i) {
            document.getElementById('edit_id').value = id;
            document.getElementById('cat_title').value = t;
            document.getElementById('cat_img').value = i;
            document.getElementById('submit_btn').innerText = "Update Now";
            document.getElementById('cancel_btn').classList.remove('hidden');
        }

        function resetForm() {
            document.getElementById('edit_id').value = '';
            document.getElementById('cat_title').value = '';
            document.getElementById('cat_img').value = '';
            const btn = document.getElementById('submit_btn');
            btn.innerText = (mode==='official') ? "Create Tournament" : "Create Category";
            document.getElementById('cancel_btn').classList.add('hidden');
        }

        async function deleteCat(id) {
            if(!confirm("⚠️ ATTENTION: Deleting this category will delete all matches inside it! Continue?")) return;
            await fetch('/api/admin', { method: 'POST', body: JSON.stringify({type:'delete_category', id}) });
            loadData();
        }

        loadData();
    </script>
</body>
</html>
