<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esports Matches</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font for Gaming Look -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Rajdhani', 'sans-serif'],
                    },
                    colors: {
                        dark: '#0B0E14',
                        card: '#151A25',
                        accent: '#6366F1'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0B0E14; color: #fff; user-select: none; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .glow-text { text-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }
        .custom-scroll::-webkit-scrollbar { width: 3px; } 
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        /* Neon Button Animation */
        .btn-neon { background: linear-gradient(90deg, #4F46E5, #7C3AED); position: relative; overflow: hidden; }
        .btn-neon::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: 0.4s; }
        .btn-neon:active::after { left: 100%; }
    </style>
</head>
<body class="font-sans pb-24 bg-[url('https://t3.ftcdn.net/jpg/05/17/83/90/360_F_517839088_O8n9xL7G0gN5iY0c0J3y2Z4.jpg')] bg-fixed bg-cover">
    
    <!-- Dark Overlay -->
    <div class="fixed inset-0 bg-[#0B0E14]/95 z-[-1]"></div>

    <!-- Stylish Header -->
    <header class="p-4 glass sticky top-0 z-50 flex justify-between items-center shadow-2xl border-b border-indigo-500/20">
        <a href="/home" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-800 text-gray-400 hover:text-white transition hover:bg-indigo-600">
            <i class="fa-solid fa-chevron-left text-lg"></i>
        </a>
        <h1 class="text-2xl font-bold tracking-widest uppercase text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 drop-shadow-sm" id="cat_title">MATCHES</h1>
        <div class="bg-gradient-to-r from-slate-800 to-slate-900 px-4 py-2 rounded-full border border-slate-700 shadow-lg flex items-center gap-2">
            <i class="fa-solid fa-coins text-yellow-400 text-xs"></i>
            <span class="text-sm font-bold tracking-wider text-yellow-100">à§³<span id="header_bal">...</span></span>
        </div>
    </header>

    <!-- Main List Area -->
    <div id="match_list" class="p-4 space-y-6 max-w-lg mx-auto">
        <div class="flex flex-col items-center justify-center mt-32 space-y-3 opacity-60 animate-pulse">
            <i class="fa-solid fa-gamepad text-5xl text-indigo-500"></i>
            <p class="text-lg tracking-widest font-bold">LOADING ARENA...</p>
        </div>
    </div>

    <!-- 1. MODERN JOIN MODAL -->
    <div id="joinModal" class="fixed inset-0 bg-black/95 z-[60] hidden flex items-end md:items-center justify-center p-4 backdrop-blur-md transition-all">
    </div>

    <!-- 2. PARTICIPANTS MODAL -->
    <div id="playersListModal" class="fixed inset-0 bg-black/95 z-[70] hidden items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-gray-900 p-0 rounded-2xl w-full max-w-sm h-[70vh] flex flex-col border border-slate-700 shadow-2xl relative overflow-hidden">
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-4 border-b border-slate-700 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-white tracking-wide">Participants</h3>
                    <p class="text-xs text-blue-400 font-medium tracking-widest" id="slot_info">UPDATING...</p>
                </div>
                <button onclick="document.getElementById('playersListModal').style.display='none'" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center hover:bg-red-500 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="joined_players_list" class="overflow-y-auto flex-1 p-3 space-y-2 custom-scroll bg-[#0f1219]"></div>
        </div>
    </div>
    
    <!-- 3. ROOM MODAL -->
    <div id="roomDetailsModal" class="fixed inset-0 bg-black/95 z-[80] hidden items-center justify-center p-6 backdrop-blur-lg">
        <div class="bg-[#121620] w-full max-w-xs rounded-2xl border border-green-500/30 shadow-[0_0_50px_rgba(34,197,94,0.2)] p-6 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-500 to-emerald-400"></div>
            <button onclick="document.getElementById('roomDetailsModal').style.display='none'" class="absolute top-3 right-3 text-gray-500 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            
            <i class="fa-solid fa-lock-open text-4xl text-green-400 mb-3 drop-shadow-[0_0_10px_rgba(34,197,94,0.5)]"></i>
            <h3 class="text-2xl font-bold text-white mb-6 tracking-wide">ACCESS GRANTED</h3>

            <div class="space-y-4">
                <div class="text-left bg-black/40 p-3 rounded-lg border border-slate-700">
                    <span class="text-[10px] text-gray-500 font-bold uppercase block tracking-widest">Room ID</span>
                    <span id="room_id_display" class="text-xl font-mono text-white tracking-widest font-bold select-all">---</span>
                </div>
                <div class="text-left bg-black/40 p-3 rounded-lg border border-slate-700">
                    <span class="text-[10px] text-gray-500 font-bold uppercase block tracking-widest">Password</span>
                    <span id="room_pass_display" class="text-xl font-mono text-yellow-400 tracking-widest font-bold select-all">---</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-[#1e293b] text-white px-6 py-3 rounded-full shadow-2xl z-[100] border border-slate-600/50 flex items-center gap-3 transition-all duration-300 opacity-0 translate-y-10">
        <span id="toast_icon" class="text-lg"></span>
        <span id="toast_msg" class="text-sm font-semibold tracking-wide">Message</span>
    </div>

    <script>
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) window.location.href = '/';

        const params = new URLSearchParams(window.location.search);
        const catId = params.get('cat_id');
        const catName = params.get('name');
        if(catName) document.getElementById('cat_title').innerText = decodeURIComponent(catName);

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            const icon = document.getElementById('toast_icon');
            icon.innerHTML = type === 'error' ? '<i class="fa-solid fa-circle-exclamation text-red-500"></i>' : '<i class="fa-solid fa-circle-check text-green-400"></i>';
            document.getElementById('toast_msg').innerText = msg;
            t.classList.remove('translate-y-10', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-10', 'opacity-0'), 3000);
        }

        async function fetchBalance() {
            try { 
                const res = await fetch('/api/user', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: 'wallet_info', user_id: user.id }) });
                const data = await res.json(); 
                if(data.balance !== undefined) document.getElementById('header_bal').innerText = parseFloat(data.balance).toFixed(0); 
            } catch(e){}
        }
        fetchBalance(); 

        // ðŸ”¥ MATCH LOADER (DESIGNED)
        async function loadMatches() {
            const list = document.getElementById('match_list');
            if(!catId) { list.innerHTML = `<p class="text-center text-red-400">Error: Invalid Category</p>`; return; }

            try {
                const res = await fetch('/api/tournament', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ type: 'get_daily_matches', category_id: parseInt(catId), user_id: user.id }) 
                });
                const matches = await res.json();

                if(Array.isArray(matches) && matches.length > 0) {
                    list.innerHTML = matches.map((m, index) => {
                        const type = m.match_type || 'Solo';
                        const adminLimit = parseInt(m.total_spots) || (type==='Solo'?48:12);
                        const joined = type === 'Solo' ? (m.joined_players || 0) : (m.joined_teams || 0);
                        const filled = Math.min((joined / adminLimit) * 100, 100);
                        const feeDisplay = parseFloat(m.entry_fee) === 0 ? "FREE" : "à§³"+m.entry_fee;
                        const d = new Date(m.match_time);
                        const dateFormatted = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
                        const timeFormatted = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });

                        let btn = '';
                        if (m.is_joined) {
                            btn = `<button onclick="viewRoom(${m.id})" class="w-full py-3 bg-gradient-to-r from-emerald-500 to-green-600 rounded-lg font-bold text-white shadow-lg shadow-green-900/30 hover:shadow-green-500/20 transition-all uppercase tracking-widest animate-pulse border border-green-400/50">Get Room ID</button>`;
                        } else if (m.status === 'open' && joined < adminLimit) {
                            btn = `<button onclick="openJoin(${m.id}, '${type}', ${m.entry_fee})" class="btn-neon w-full py-3 rounded-lg font-bold text-white shadow-lg shadow-indigo-500/30 transition-all tracking-widest text-sm uppercase">Join Match</button>`;
                        } else {
                            btn = `<button disabled class="w-full py-3 bg-slate-800 border border-slate-700 rounded-lg text-gray-500 font-bold uppercase tracking-widest">Locked</button>`;
                        }

                        // BADGE COLOR
                        const badgeColor = m.status === 'open' ? 'text-green-400 bg-green-500/10 border-green-500/20' : 'text-yellow-400 bg-yellow-500/10 border-yellow-500/20';

                        return `
                        <div class="relative bg-card rounded-2xl border border-slate-700/60 shadow-xl overflow-hidden group hover:border-indigo-500/40 transition duration-300">
                            <!-- Background Gradient -->
                            <div class="absolute inset-0 bg-gradient-to-b from-indigo-500/5 to-transparent pointer-events-none"></div>

                            <!-- Header -->
                            <div class="p-4 border-b border-slate-700/60 flex justify-between items-center relative">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[10px] font-bold text-blue-200 bg-blue-600/80 px-2 py-0.5 rounded shadow">MATCH #${index + 1}</span>
                                        <span class="text-[10px] font-mono text-slate-400">ID: ${m.id}</span>
                                    </div>
                                    <h2 class="text-xl font-bold text-white tracking-wide leading-none truncate w-48 drop-shadow-md">${m.title}</h2>
                                </div>
                                <div class="text-right">
                                    <p class="text-2xl font-bold text-indigo-400 leading-none glow-text">${timeFormatted}</p>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">${dateFormatted}</p>
                                </div>
                            </div>

                            <!-- Body -->
                            <div class="p-4 relative">
                                <!-- Stats -->
                                <div class="grid grid-cols-3 gap-2 text-center mb-4 bg-slate-900/50 p-2 rounded-xl border border-slate-700/50">
                                    <div><p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider">Prize</p><p class="text-green-400 font-black text-lg">à§³${m.prize_pool}</p></div>
                                    <div class="border-l border-r border-slate-700"><p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider">Fee</p><p class="text-yellow-400 font-black text-lg">${feeDisplay}</p></div>
                                    <div><p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider">Mode</p><p class="text-blue-400 font-black text-lg uppercase">${type}</p></div>
                                </div>

                                <!-- Info Row -->
                                <div class="flex justify-between items-center mb-3 text-[11px] font-bold text-slate-300 px-1">
                                    <div class="flex items-center gap-1.5"><i class="fa-solid fa-map text-indigo-400"></i> ${m.map || 'Random'}</div>
                                    <div class="flex items-center gap-1.5"><i class="fa-solid fa-crosshairs text-red-500"></i> Per Kill: <span class="text-white">à§³${m.per_kill}</span></div>
                                </div>

                                <!-- Progress -->
                                <div class="mb-5">
                                    <div class="flex justify-between text-[10px] font-bold uppercase tracking-widest mb-1.5 text-slate-400">
                                        <span onclick="viewPlayers(${m.id}, ${adminLimit}, '${type}')" class="hover:text-blue-400 cursor-pointer underline decoration-blue-500/50 decoration-2 underline-offset-2 transition">
                                            Participants (${joined}/${adminLimit})
                                        </span>
                                        <span class="${badgeColor} px-1.5 py-0.5 rounded border text-[9px]">${m.status}</span>
                                    </div>
                                    <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-1000 ease-out relative" style="width: ${filled}%">
                                            <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Button -->
                                ${btn}
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    list.innerHTML = `<div class="flex flex-col items-center justify-center mt-32 opacity-50 space-y-4">
                        <i class="fa-solid fa-folder-open text-6xl text-slate-700"></i>
                        <p class="text-slate-500 font-bold uppercase tracking-widest">No Active Matches</p>
                    </div>`;
                }
            } catch(e) { console.error(e); }
        }

        function openJoin(id, type, fee) {
            const count = (type === 'Duo') ? 2 : (type.includes('Squad') ? 4 : 1);
            let teamHTML = count > 1 ? `
            <div class="mb-5">
                <label class="text-[10px] font-bold text-blue-400 uppercase mb-1.5 block tracking-widest pl-1">Team Name (Required)</label>
                <div class="bg-black/30 border border-slate-600 rounded-xl p-3 flex items-center focus-within:border-blue-500 transition">
                    <i class="fa-solid fa-users text-slate-500 mr-3 text-sm"></i>
                    <input type="text" id="team_name" class="bg-transparent w-full text-white text-sm outline-none font-bold placeholder-slate-600" placeholder="e.g. Royal Strikers">
                </div>
            </div>` : '';

            let playerHTML = '';
            for(let i=1; i<=count; i++) {
                const label = i===1 ? '(You/Leader)' : '';
                playerHTML += `
                <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700 mb-3 relative group">
                    <span class="absolute -top-2 left-3 bg-slate-700 text-slate-300 text-[9px] px-2 py-0.5 rounded border border-slate-600 font-bold uppercase">Player ${i} ${label}</span>
                    <div class="grid grid-cols-5 gap-3 mt-1">
                        <div class="col-span-3">
                            <input id="name_${i}" class="w-full bg-slate-900 border border-slate-600 text-white text-xs p-2.5 rounded-lg outline-none focus:border-blue-500 placeholder-slate-600 font-medium" placeholder="Game Name">
                        </div>
                        <div class="col-span-2">
                            <input id="lvl_${i}" type="number" class="w-full bg-slate-900 border border-slate-600 text-white text-xs p-2.5 rounded-lg outline-none focus:border-blue-500 placeholder-slate-600 text-center font-bold" placeholder="Lvl (40+)">
                        </div>
                    </div>
                    <input id="uid_${i}" type="number" class="w-full mt-2 bg-slate-900 border-none text-slate-400 text-[10px] p-2 rounded-lg placeholder-slate-600" placeholder="Optional UID">
                </div>`;
            }

            document.getElementById('joinModal').innerHTML = `
                <div class="bg-[#0B0E14] w-full max-w-md h-[90vh] md:h-auto rounded-t-3xl md:rounded-3xl border-t md:border border-slate-700 shadow-[0_0_60px_rgba(0,0,0,0.8)] flex flex-col relative animate-slide-up">
                    <div class="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900/50 rounded-t-3xl">
                        <div>
                            <h3 class="font-bold text-xl text-white tracking-wide">Confirm Entry</h3>
                            <p class="text-[11px] text-slate-400 uppercase tracking-widest mt-1">${type} Match</p>
                        </div>
                        <div class="text-right">
                             <span class="block text-[10px] text-slate-500 uppercase font-bold">Entry Fee</span>
                             <span class="text-xl font-black text-yellow-400 tracking-tight">${fee===0 ? "FREE" : "à§³"+fee}</span>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-5 custom-scroll pb-10 space-y-1">
                        ${teamHTML}
                        ${playerHTML}
                    </div>
                    <div class="p-5 border-t border-slate-800 bg-slate-900">
                        <button onclick="confirmJoin('${id}', '${type}')" id="join_confirm_btn" class="btn-neon w-full py-4 rounded-xl font-black text-white uppercase tracking-widest text-sm shadow-lg hover:shadow-indigo-500/25 transition-all">
                            Complete Payment
                        </button>
                        <button onclick="document.getElementById('joinModal').style.display='none'" class="w-full mt-3 text-xs font-bold text-slate-500 hover:text-white uppercase tracking-widest transition">Cancel</button>
                    </div>
                </div>`;
            document.getElementById('joinModal').style.display = 'flex';
        }

        async function confirmJoin(id, type) {
            const count = (type === 'Duo') ? 2 : (type.includes('Squad') ? 4 : 1);
            let tName = '';
            if(count > 1) { tName = document.getElementById('team_name').value; if(!tName) return showToast("Enter Team Name", "error"); }
            
            let players = [];
            for(let i=1; i<=count; i++) {
                let n = document.getElementById(`name_${i}`).value;
                let u = document.getElementById(`uid_${i}`).value;
                let l = document.getElementById(`lvl_${i}`).value;
                if(!n || !l) return showToast(`Details missing for Player ${i}`, "error");
                if(parseInt(l) < 40) return showToast(`Player ${i} Level must be 40+`, "error");
                players.push({name:n, uid:u, level:l});
            }
            const btn = document.getElementById('join_confirm_btn'); btn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> PROCESSING'; btn.disabled=true;
            try {
                const res = await fetch('/api/tournament', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: 'join_daily_match', user_id: user.id, match_id: id, team_name: tName, players: players }) });
                const d = await res.json();
                if(d.success) { showToast("Successfully Joined!", "success"); document.getElementById('joinModal').style.display='none'; loadMatches(); fetchBalance(); }
                else { showToast(d.error, "error"); btn.innerHTML="TRY AGAIN"; btn.disabled=false; }
            } catch(e) { showToast("Network Failed", "error"); btn.disabled=false; }
        }

        async function viewPlayers(id, total, type) {
            document.getElementById('playersListModal').style.display='flex';
            document.getElementById('slot_info').innerText=`${total} AVAILABLE SLOTS`;
            document.getElementById('joined_players_list').innerHTML = '<div class="text-center pt-20 animate-pulse text-gray-500 uppercase text-xs font-bold tracking-widest">Retrieving Data...</div>';
            
            try {
                const res = await fetch('/api/tournament', {method:'POST', body:JSON.stringify({type:'get_daily_participants', match_id:id})});
                const d = await res.json();
                let html='', count=0;
                
                if (type !== 'Solo' && d.length>0) {
                     const gps={}; d.forEach(p=>{let t=p.team_name||"Unknow";if(!gps[t])gps[t]=[];gps[t].push(p)});
                     const keys=Object.keys(gps); count=keys.length;
                     keys.forEach((kn, i) => {
                         let items = gps[kn].map(m=>`
                         <div class="flex justify-between items-center text-[10px] text-gray-400 py-1.5 pl-3 border-l-2 border-slate-700 bg-slate-900/30 mb-1 rounded-r-lg">
                             <div class="font-bold text-gray-300 flex items-center gap-2"><i class="fa-solid fa-gamepad text-indigo-500"></i> ${m.game_name}</div>
                             <span class="font-bold text-yellow-600 bg-yellow-900/20 px-1.5 py-0.5 rounded text-[9px]">Lvl ${m.game_level}</span>
                         </div>`).join('');
                         html += `<div class="bg-[#121620] border border-indigo-500/20 rounded-xl mb-3 overflow-hidden shadow-md transition hover:border-indigo-500/50 group"><div onclick="this.nextElementSibling.classList.toggle('hidden')" class="p-3 flex justify-between items-center cursor-pointer bg-gradient-to-r from-slate-800 to-slate-900"><span class="text-xs font-bold text-white uppercase flex items-center gap-2 tracking-wide"><span class="bg-indigo-600 text-[9px] w-5 h-5 flex items-center justify-center rounded-full text-white shadow-lg shadow-indigo-500/40">${i+1}</span> ${kn}</span><i class="fa-solid fa-angle-down text-gray-500 transition group-hover:text-white"></i></div><div class="hidden p-3 border-t border-slate-700/50 space-y-1">${items}</div></div>`;
                     });
                } else {
                    count=d.length; d.forEach((p,i)=> { html+=`<div class="flex justify-between items-center bg-[#121620] p-3 rounded-xl mb-2 border border-slate-700/50 shadow-sm"><div class="flex items-center gap-3"><div class="w-6 h-6 rounded-full bg-emerald-900/30 text-emerald-400 border border-emerald-500/30 flex items-center justify-center text-[10px] font-bold">#${i+1}</div><div><h4 class="text-sm font-bold text-white">${p.game_name}</h4><p class="text-[9px] text-gray-500 uppercase font-bold tracking-widest">Level: <span class="text-yellow-500">${p.game_level}</span></p></div></div><i class="fa-solid fa-shield-halved text-slate-600 text-xs"></i></div>`; });
                }

                for(let i=0; i<(total-count); i++) html+=`<div class="border-2 border-slate-800 border-dashed rounded-xl p-3 mb-2 flex justify-between items-center opacity-40"><span class="text-xs text-gray-500 font-bold uppercase tracking-wider pl-2">Slot ${count+i+1}</span><span class="text-[9px] bg-slate-800 text-slate-500 px-2 py-0.5 rounded uppercase font-bold">Empty</span></div>`;
                document.getElementById('joined_players_list').innerHTML = html;
            } catch(e) { console.error(e); }
        }

        async function viewRoom(id) {
             const res = await fetch('/api/tournament', { method:'POST', body:JSON.stringify({ type:'get_daily_room', user_id:user.id, match_id:id})});
             const d = await res.json();
             if(d.room_id && d.room_id.trim() !== "" && d.room_id !== "null") { 
                 document.getElementById('roomDetailsModal').style.display='flex'; 
                 document.getElementById('room_id_display').innerText = d.room_id; 
                 document.getElementById('room_pass_display').innerText = d.room_pass; 
             } else { showToast("Room details will be available 15m before start.", "error"); }
        }

        loadMatches();
    </script>
</body>
</html>
