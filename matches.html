<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Matches</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Rajdhani', 'sans-serif'] },
                    colors: { dark: '#0B0E14', card: '#151A25' }
                }
            }
        }
    </script>
    <style>
        body { user-select: none; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(20, 25, 35, 0.7); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .glow-text { text-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }
        .custom-scroll::-webkit-scrollbar { width: 3px; } 
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .btn-neon { background: linear-gradient(135deg, #3b82f6, #6366f1); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); transition: all 0.3s ease; }
        .btn-neon:active { transform: scale(0.95); box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3); }
    </style>
</head>
<body class="font-sans pb-24 bg-[#0B0E14] text-white min-h-screen">

    <div class="fixed inset-0 z-[-1] bg-gradient-to-br from-[#0a0d13] via-[#0f121a] to-[#141824]"></div>

    <!-- Header -->
    <header class="p-4 glass sticky top-0 z-50 flex justify-between items-center shadow-lg">
        <a href="/home" class="w-9 h-9 flex items-center justify-center rounded-full bg-slate-800/50 text-gray-400 hover:text-white transition hover:bg-blue-600/20 border border-slate-700"><i class="fa-solid fa-arrow-left"></i></a>
        <h1 class="text-xl font-bold tracking-widest uppercase text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400" id="cat_title">MATCHES</h1>
        <div class="bg-slate-900/80 px-3 py-1.5 rounded-full border border-slate-700/60 shadow-sm flex items-center gap-1.5">
            <i class="fa-solid fa-coins text-yellow-400 text-xs"></i>
            <span class="text-sm font-bold tracking-wide text-gray-200">à§³<span id="header_bal">...</span></span>
        </div>
    </header>

    <div id="match_list" class="p-4 space-y-6 max-w-lg mx-auto">
        <div class="flex flex-col items-center justify-center mt-32 space-y-3 opacity-60 animate-pulse">
            <i class="fa-solid fa-gamepad text-5xl text-slate-700"></i>
            <p class="text-xs font-bold text-slate-500 tracking-[0.2em] uppercase">Checking Active Lobbies...</p>
        </div>
    </div>

    <!-- Modals -->
    <div id="joinModal" class="fixed inset-0 bg-black/95 z-[60] hidden items-end md:items-center justify-center p-0 md:p-4 backdrop-blur-md"></div>
    <div id="playersListModal" class="fixed inset-0 bg-black/95 z-[70] hidden items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-[#121620] w-full max-w-sm h-[70vh] flex flex-col rounded-2xl border border-slate-700 shadow-2xl relative overflow-hidden animate-zoom">
            <div class="p-4 border-b border-slate-700/60 flex justify-between items-center bg-slate-900/40">
                <div><h3 class="text-lg font-bold text-white tracking-wide">Player List</h3><p class="text-[10px] text-blue-400 font-bold uppercase tracking-wider" id="slot_info">Loading...</p></div>
                <button onclick="document.getElementById('playersListModal').style.display='none'" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-800 text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="joined_players_list" class="overflow-y-auto flex-1 p-2 space-y-2 custom-scroll bg-[#0f1219]"></div>
        </div>
    </div>
    
    <div id="roomDetailsModal" class="fixed inset-0 bg-black/95 z-[80] hidden items-center justify-center p-6 backdrop-blur-lg">
        <div class="bg-[#151a24] w-full max-w-xs rounded-2xl border border-green-500/30 shadow-[0_0_40px_rgba(0,0,0,0.8)] p-6 text-center relative">
            <button onclick="document.getElementById('roomDetailsModal').style.display='none'" class="absolute top-3 right-3 text-gray-500 hover:text-white"><i class="fa-solid fa-xmark text-lg"></i></button>
            <div class="w-12 h-12 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-green-500/20"><i class="fa-solid fa-lock-open text-xl text-green-400"></i></div>
            <h3 class="text-lg font-bold text-white mb-5 tracking-wide">ROOM ACCESS</h3>
            <div class="space-y-3 text-left">
                <div class="bg-black/40 p-3 rounded-lg border border-slate-700/60"><span class="text-[9px] text-gray-500 font-bold uppercase tracking-widest block mb-0.5">Room ID</span><span id="room_id_display" class="text-lg font-mono text-yellow-400 tracking-wider font-bold select-all">---</span></div>
                <div class="bg-black/40 p-3 rounded-lg border border-slate-700/60"><span class="text-[9px] text-gray-500 font-bold uppercase tracking-widest block mb-0.5">Password</span><span id="room_pass_display" class="text-lg font-mono text-green-400 tracking-wider font-bold select-all">---</span></div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-[#1e293b] text-white px-5 py-3 rounded-full shadow-2xl z-[100] border border-slate-600 flex items-center gap-3 transition-all duration-300 opacity-0 translate-y-10 min-w-[200px] justify-center"><span id="toast_icon"></span> <span id="toast_msg" class="text-xs font-bold tracking-wide">Msg</span></div>

    <script>
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) window.location.href = '/';

        const params = new URLSearchParams(window.location.search);
        const catId = params.get('cat_id');
        const catName = params.get('name');
        if(catName) document.getElementById('cat_title').innerText = decodeURIComponent(catName);

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            document.getElementById('toast_icon').innerHTML = type === 'error' ? '<i class="fa-solid fa-circle-exclamation text-red-500"></i>' : '<i class="fa-solid fa-circle-check text-green-400"></i>';
            document.getElementById('toast_msg').innerText = msg;
            t.classList.remove('translate-y-10', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-10', 'opacity-0'), 3000);
        }

        async function fetchBalance() {
            try { 
                const res = await fetch('/api/user', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: 'wallet_info', user_id: user.id }) });
                const data = await res.json(); 
                if(data.balance !== undefined) document.getElementById('header_bal').innerText = parseFloat(data.balance).toFixed(0); 
            } catch(e){}
        }
        fetchBalance(); 

        async function loadMatches() {
            const list = document.getElementById('match_list');
            if(!catId) { list.innerHTML = `<p class="text-center text-red-400 mt-20 text-xs">Error: Invalid Category</p>`; return; }

            try {
                const res = await fetch('/api/tournament', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ type: 'get_daily_matches', category_id: parseInt(catId), user_id: user.id }) 
                });
                const matches = await res.json();

                if(Array.isArray(matches) && matches.length > 0) {
                    list.innerHTML = matches.map((m, index) => {
                        const type = m.match_type || 'Solo';
                        const adminLimit = parseInt(m.total_spots) || (type==='Solo'?48:(type==='Duo'?24:12));
                        const joined = type === 'Solo' ? (m.joined_players || 0) : (m.joined_teams || 0);
                        const filled = Math.min((joined / adminLimit) * 100, 100);
                        const feeDisplay = parseFloat(m.entry_fee) === 0 ? "FREE" : "à§³"+m.entry_fee;
                        const d = new Date(m.match_time);
                        const dateFormatted = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
                        const timeFormatted = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });

                        const status = m.status || 'upcoming';
                        const isJoined = m.is_joined > 0;

                        // ðŸ”¥ FIXED STATUS LOGIC
                        let btn = '';
                        let displayStatus = status.toUpperCase();
                        let statusColor = 'text-gray-400';
                        let statusBadgeColor = 'border-slate-500/50 bg-slate-500/10 text-slate-400';

                        if (status === 'completed') {
                            displayStatus = 'COMPLETED';
                            statusBadgeColor = 'border-purple-500/50 bg-purple-500/10 text-purple-400';
                            btn = `<button disabled class="w-full py-3 bg-purple-900/20 text-purple-400 border border-purple-500/30 rounded-xl font-bold uppercase tracking-widest text-xs">View Results</button>`;
                        }
                        else if (status === 'live') {
                            displayStatus = 'LIVE ðŸ”´';
                            statusBadgeColor = 'border-red-500/50 bg-red-500/10 text-red-500 animate-pulse';
                            btn = `<button disabled class="w-full py-3 bg-red-900/30 text-red-500 border border-red-500/40 rounded-xl font-bold uppercase tracking-widest text-xs cursor-not-allowed">Match Started</button>`;
                        }
                        else if (status === 'upcoming') {
                            displayStatus = 'UPCOMING';
                            statusBadgeColor = 'border-yellow-500/50 bg-yellow-500/10 text-yellow-500';
                            btn = `<button disabled class="w-full py-3 bg-slate-800 border border-slate-700 text-gray-500 font-bold uppercase tracking-widest text-xs cursor-not-allowed">Coming Soon</button>`;
                        }
                        else if (status === 'open') {
                            displayStatus = 'OPEN';
                            statusBadgeColor = 'border-green-500/50 bg-green-500/10 text-green-400';
                            
                            if (isJoined) {
                                btn = `<button onclick="viewRoom(${m.id})" class="w-full py-3 bg-gradient-to-r from-emerald-500 to-green-600 rounded-lg font-bold text-white shadow-lg uppercase tracking-widest text-xs border border-green-400/50 animate-pulse">Get Room ID</button>`;
                            } else if (joined >= adminLimit) {
                                displayStatus = 'FULL';
                                statusBadgeColor = 'border-red-500/50 bg-red-500/10 text-red-400';
                                btn = `<button disabled class="w-full py-3 bg-slate-800 text-gray-500 border border-slate-700 rounded-lg font-bold uppercase tracking-widest text-xs cursor-not-allowed">Slots Full</button>`;
                            } else {
                                btn = `<button onclick="openJoin(${m.id}, '${type}', ${m.entry_fee})" class="btn-neon w-full py-3 rounded-lg font-bold text-white shadow-lg tracking-widest text-xs uppercase">Join Match</button>`;
                            }
                        }

                        return `
                        <div class="relative bg-card rounded-2xl border border-slate-700/60 shadow-xl overflow-hidden group hover:border-indigo-500/40 transition duration-300">
                            <div class="absolute inset-0 bg-gradient-to-b from-indigo-500/5 to-transparent pointer-events-none"></div>

                            <div class="p-4 border-b border-slate-700/60 flex justify-between items-center bg-slate-900/30">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[9px] font-bold text-blue-200 bg-blue-600/80 px-2 py-0.5 rounded shadow">MATCH #${index + 1}</span>
                                        <span class="text-[9px] font-mono text-slate-400">ID: ${m.id}</span>
                                    </div>
                                    <h2 class="text-xl font-bold text-white tracking-wide leading-none truncate w-48 drop-shadow-md">${m.title}</h2>
                                </div>
                                <div class="text-right">
                                    <p class="text-2xl font-bold text-indigo-400 leading-none glow-text">${timeFormatted}</p>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">${dateFormatted}</p>
                                </div>
                            </div>

                            <div class="p-4 relative">
                                <div class="grid grid-cols-3 gap-2 text-center mb-4 bg-slate-900/50 p-2 rounded-xl border border-slate-700/50">
                                    <div><p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider">Prize</p><p class="text-green-400 font-black text-lg">à§³${m.prize_pool}</p></div>
                                    <div class="border-l border-r border-slate-700"><p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider">Fee</p><p class="text-yellow-400 font-black text-lg">${feeDisplay}</p></div>
                                    <div><p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider">Mode</p><p class="text-blue-400 font-black text-lg uppercase">${type}</p></div>
                                </div>

                                <div class="flex justify-between items-center mb-3 text-[11px] font-bold text-slate-300 px-1">
                                    <div class="flex items-center gap-1.5"><i class="fa-solid fa-map text-indigo-400"></i> ${m.map || 'Random'}</div>
                                    <div class="flex items-center gap-1.5"><i class="fa-solid fa-crosshairs text-red-500"></i> Per Kill: <span class="text-white">à§³${m.per_kill}</span></div>
                                </div>

                                <div class="mb-5">
                                    <div class="flex justify-between text-[10px] font-bold uppercase tracking-widest mb-1.5 text-slate-400">
                                        <span onclick="viewPlayers(${m.id}, ${adminLimit}, '${type}')" class="hover:text-blue-400 cursor-pointer underline decoration-blue-500/50 decoration-2 underline-offset-2 transition">
                                            Participants (${joined}/${adminLimit})
                                        </span>
                                        <span class="${statusBadgeColor} px-1.5 py-0.5 rounded border text-[9px] flex items-center gap-1">
                                            <span class="w-1 h-1 rounded-full bg-current animate-pulse"></span>
                                            ${displayStatus}
                                        </span>
                                    </div>
                                    <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-1000 ease-out relative" style="width: ${filled}%">
                                            <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                                        </div>
                                    </div>
                                </div>

                                ${btn}
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    list.innerHTML = `<div class="flex flex-col items-center justify-center mt-32 opacity-50 space-y-4"><i class="fa-solid fa-folder-open text-6xl text-slate-700"></i><p class="text-slate-500 font-bold uppercase tracking-widest text-xs">No Active Lobbies</p></div>`;
                }
            } catch(e) { console.error(e); }
        }

        // Functions for Modals & Logic
        function openJoin(id, type, fee) {
            const count = (type === 'Duo') ? 2 : (type.includes('Squad') ? 4 : 1);
            let teamHTML = count > 1 ? `<div class="mb-5"><label class="text-[10px] font-bold text-blue-400 uppercase mb-1.5 block tracking-widest pl-1">Team Name (Required)</label><div class="bg-black/30 border border-slate-600 rounded-xl p-3 flex items-center focus-within:border-blue-500 transition"><i class="fa-solid fa-users text-slate-500 mr-3 text-sm"></i><input type="text" id="team_name" class="bg-transparent w-full text-white text-sm outline-none font-bold placeholder-slate-600" placeholder="e.g. Royal Strikers"></div></div>` : '';

            let playerHTML = '';
            for(let i=1; i<=count; i++) {
                const label = i===1 ? '(You)' : '';
                playerHTML += `<div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700 mb-3 relative group"><span class="absolute -top-2 left-3 bg-slate-700 text-slate-300 text-[9px] px-2 py-0.5 rounded border border-slate-600 font-bold uppercase">Player ${i} ${label}</span><div class="grid grid-cols-5 gap-3 mt-1"><div class="col-span-3"><input id="name_${i}" class="w-full bg-slate-900 border border-slate-600 text-white text-xs p-2.5 rounded-lg outline-none focus:border-blue-500 placeholder-slate-600 font-medium" placeholder="Game Name"></div><div class="col-span-2"><input id="lvl_${i}" type="number" class="w-full bg-slate-900 border border-slate-600 text-white text-xs p-2.5 rounded-lg outline-none focus:border-blue-500 placeholder-slate-600 text-center font-bold" placeholder="Lvl (40+)"></div></div><input id="uid_${i}" type="number" class="w-full mt-2 bg-slate-900 border-none text-slate-400 text-[10px] p-2 rounded-lg placeholder-slate-600" placeholder="Optional UID"></div>`;
            }

            const feeTxt = fee === 0 ? "FREE ENTRY" : `PAY à§³${fee}`;
            document.getElementById('joinModal').innerHTML = `<div class="bg-[#10141d] w-full max-w-md h-[90vh] md:h-auto rounded-t-3xl md:rounded-3xl border-t md:border border-slate-700 shadow-2xl flex flex-col relative animate-slide-up"><div class="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900/50 backdrop-blur-md rounded-t-3xl"><div><h3 class="font-bold text-xl text-white tracking-wide">Confirm Entry</h3><p class="text-[11px] text-slate-400 uppercase tracking-widest mt-1">${type} Match â€¢ <span class="text-yellow-400 font-bold">${feeTxt}</span></p></div><button onclick="document.getElementById('joinModal').style.display='none'" class="w-8 h-8 rounded-full bg-slate-800 text-gray-400 hover:text-white transition shadow"><i class="fa-solid fa-xmark"></i></button></div><div class="flex-1 overflow-y-auto p-5 custom-scroll pb-10 space-y-1">${teamHTML}${playerHTML}</div><div class="p-5 border-t border-slate-800 bg-slate-900 rounded-b-3xl"><button onclick="confirmJoin('${id}', '${type}')" id="join_confirm_btn" class="btn-neon w-full py-4 rounded-xl font-black text-white uppercase tracking-widest text-sm shadow-lg transition transform hover:scale-[1.02]">Confirm Join</button></div></div>`;
            document.getElementById('joinModal').style.display = 'flex';
        }

        async function confirmJoin(id, type) {
            const count = (type === 'Duo') ? 2 : (type.includes('Squad') ? 4 : 1);
            let tName = ''; if(count > 1) { tName = document.getElementById('team_name').value; if(!tName) return showToast("Enter Team Name", "error"); }
            
            let players = []; for(let i=1; i<=count; i++) { let n = document.getElementById(`name_${i}`).value, u = document.getElementById(`uid_${i}`).value, l = document.getElementById(`lvl_${i}`).value; if(!n || !l) return showToast(`Missing Info Player ${i}`, "error"); if(parseInt(l) < 40) return showToast(`Player ${i} needs Lvl 40+`, "error"); players.push({name:n, uid:u, level:l}); }
            const btn = document.getElementById('join_confirm_btn'); btn.innerText='PROCESSING'; btn.disabled=true;
            try { const res = await fetch('/api/tournament', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: 'join_daily_match', user_id: user.id, match_id: id, team_name: tName, players: players }) }); const d = await res.json(); if(d.success) { showToast("Successfully Joined!", "success"); document.getElementById('joinModal').style.display='none'; loadMatches(); fetchBalance(); } else { showToast(d.error, "error"); btn.disabled=false; btn.innerText="RETRY"; } } catch(e) { showToast("Network Error", "error"); btn.disabled=false; }
        }

        async function viewPlayers(id, total, type) {
            document.getElementById('playersListModal').style.display='flex';
            document.getElementById('slot_info').innerText=`${total} SLOTS AVAILABLE`;
            document.getElementById('joined_players_list').innerHTML = '<div class="text-center pt-20 animate-pulse text-gray-500 uppercase text-[10px] font-bold tracking-widest">Retrieving Data...</div>';
            try {
                const res = await fetch('/api/tournament', {method:'POST', body:JSON.stringify({type:'get_daily_participants', match_id:id})});
                const d = await res.json();
                let html='', filled=0;
                
                if (type !== 'Solo' && d.length>0) {
                     const gps={}; d.forEach(p=>{let t=p.team_name||"Unknow";if(!gps[t])gps[t]=[];gps[t].push(p)});
                     const keys=Object.keys(gps); filled=keys.length;
                     keys.forEach((k, i) => { let items = gps[k].map(m=>`<div class="flex justify-between items-center text-[10px] text-gray-400 py-1.5 pl-3 border-l-2 border-indigo-500 bg-slate-900/40 mb-1 rounded-r-lg"><div>${m.game_name}</div><div class="text-right text-yellow-600 font-bold text-[9px]">Lvl ${m.game_level}</div></div>`).join(''); html += `<div class="bg-[#121620] border border-slate-700/50 rounded-xl mb-3 overflow-hidden shadow-sm transition hover:border-indigo-500/50 group"><div onclick="this.nextElementSibling.classList.toggle('hidden')" class="p-3 flex justify-between items-center cursor-pointer bg-gradient-to-r from-slate-800 to-slate-900"><span class="text-xs font-bold text-white uppercase flex items-center gap-2 tracking-wide"><span class="bg-indigo-600 text-[9px] px-1.5 py-0.5 rounded text-white shadow">#${i+1}</span> ${k}</span><i class="fa-solid fa-angle-down text-gray-500 transition"></i></div><div class="hidden p-3 border-t border-slate-700/50 space-y-1">${items}</div></div>`; });
                } else {
                    filled=d.length; d.forEach((p,i)=> { html+=`<div class="flex justify-between items-center bg-[#121620] p-3 rounded-xl mb-2 border border-slate-700/50 shadow-sm"><div class="flex items-center gap-3"><div class="w-6 h-6 rounded-full bg-emerald-900/30 text-emerald-400 border border-emerald-500/30 flex items-center justify-center text-[10px] font-bold">#${i+1}</div><div><h4 class="text-sm font-bold text-white">${p.game_name}</h4><p class="text-[9px] text-gray-500 uppercase font-bold tracking-widest">Level: <span class="text-yellow-500">${p.game_level}</span></p></div></div><i class="fa-solid fa-shield-halved text-slate-600 text-xs"></i></div>`; });
                }
                for(let i=0; i<(total-filled); i++) html+=`<div class="border-2 border-slate-800 border-dashed rounded-xl p-3 mb-2 flex justify-between items-center opacity-40"><span class="text-xs text-gray-500 font-bold uppercase tracking-wider pl-2">Slot ${filled+i+1}</span><span class="text-[9px] bg-slate-800 text-slate-500 px-2 py-0.5 rounded uppercase font-bold">Empty</span></div>`;
                document.getElementById('joined_players_list').innerHTML = html;
            } catch(e) { console.error(e); }
        }

        async function viewRoom(id) {
             try {
                 const res = await fetch('/api/tournament', { method:'POST', body:JSON.stringify({ type:'get_daily_room', user_id:user.id, match_id:id})});
                 const d = await res.json();
                 if(d.room_id && d.room_id.trim() !== "" && d.room_id !== "null") { 
                     document.getElementById('roomDetailsModal').style.display='flex'; 
                     document.getElementById('room_id_display').innerText = d.room_id; 
                     document.getElementById('room_pass_display').innerText = d.room_pass; 
                 } else { showToast("Room info will be provided 15 minutes before the match.", "error"); }
             } catch(e) { showToast("Connection Error", "error"); }
        }

        loadMatches();
    </script>
</body>
</html>
